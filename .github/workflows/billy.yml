name: billy

on:
  workflow_dispatch:
    inputs:
      increaseVersion:
        description: "increase version - yes/no"
        default: "yes"
        required: false
      # deployTo:
      #   description: 'comma separated list of envs to deploy'

jobs:
  build:
    if: ${{ 
      (github.event_name == 'workflow_dispatch' 
      || contains(github.event.head_commit.message, '#build') 
      || github.ref == 'refs/heads/main' 
      || github.ref == 'refs/heads/master')
      && !contains(github.event.head_commit.message, '#skip-build') 
    }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v2
        with:
          path: ${{ env.git_repo_name }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16

      - name: Echo env vars
        run: |
          echo "Commit: $GITHUB_SHA"
          echo "Branch: $GITHUB_REF"

      - name: Manifest Generation
        run: |
          set -e

          export BILLY_SERVER="https://billy.dev-aqua.codesec.aquasec.com"

          echo "Downloading install.sh..."
          curl -sLo install.sh https://download.codesec.aquasec.com/billy/install.sh

          echo "Downloading checksum..."
          curl -sLo install.sh.checksum https://github.com/argonsecurity/releases/releases/latest/download/install.sh.checksum

          echo "Verifying checksum..."
          if ! cat install.sh.checksum | sha256sum --check; then
            echo "install.sh checksum failed"
            exit 1
          fi

          echo "Running Billy installer..."
          BINDIR="." sh install.sh

          rm install.sh install.sh.checksum

          echo "Running Billy generate..."
          ./billy generate \
            --access-token "${{ secrets.TOKEN }}" \
            --aqua-key "${{ secrets.DEV_AQUA_KEY }}" \
            --aqua-secret "${{ secrets.DEV_AQUA_SECRET }}" \
            --cspm-url "https://stage.api.cloudsploit.com" \
            --artifact-path "."

          echo "Billy run completed!"
